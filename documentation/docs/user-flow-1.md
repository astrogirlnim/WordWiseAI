# User Flow 1: Real-Time Funnel Collaboration

## Goal
Enable marketing team members to collaborate on funnel pages in real time, streamlining team-based copy creation and reviews.

---

## Phase 1: Funnel Document Creation & Goals

### Background/Architecture
- Uses: `components/writing-goals-modal.tsx`, `components/document-container.tsx`, `hooks/use-documents.ts`, `types/writing-goals.ts`, `types/document.ts`
- Documents are created with a title and writing goals (audience, intent, etc.)
- Writing goals are stored in document metadata for downstream AI and UI features

### Steps
- [ ] Add/verify UI for creating a new document (DocumentContainer)
- [ ] Show Writing Goals modal on new document creation
- [ ] Save writing goals and title to Firestore on document creation
- [ ] Ensure document type supports goal metadata

---

## Phase 1.5: AI-Powered Funnel Copy Suggestions

### Background/Architecture
- New/changed files:
  - `functions/generateFunnelSuggestions.ts` (new Cloud Function)
  - `services/ai-service.ts` (add `generateFunnelSuggestions` method)
  - `types/ai-features.ts` (add suggestion types: 'headline', 'subheadline', 'cta', 'outline')
  - `components/ai-sidebar.tsx` (add funnel suggestions section/tab)
  - `components/ai-suggestions.tsx` (render new suggestion types)
  - `hooks/use-ai-suggestions.ts` (subscribe to Firestore suggestions)
- Suggestions are generated by a Cloud Function using OpenAI, based on writing goals and current draft
- Suggestions are stored in Firestore under `/documents/{docId}/suggestions`
- UI displays suggestions in the AI Assistant sidebar, allowing apply/dismiss

### Steps
- [ ] Backend: Implement `generateFunnelSuggestions` Cloud Function
  - [ ] Accepts documentId, writing goals, and current draft
  - [ ] Calls OpenAI with a prompt tailored to goals
  - [ ] Returns JSON with suggestions (headline, subheadline, cta, outline)
  - [ ] Stores suggestions in Firestore
- [ ] Extend `ai-service.ts` to call new function
- [ ] Update `types/ai-features.ts` to support new suggestion types
- [ ] Create/extend `hooks/use-ai-suggestions.ts` to fetch suggestions
- [ ] Update `ai-sidebar.tsx` to show funnel suggestions in a dedicated section/tab
- [ ] Update `ai-suggestions.tsx` to render and handle new suggestion types
- [ ] Allow users to apply/dismiss suggestions; insert applied text at cursor/selection
- [ ] Trigger suggestion generation on document creation and when writing goals change

---

## Phase 2: Real-Time Collaboration & Presence

### Background/Architecture
- Uses: `services/collaboration-service.ts`, `components/document-container.tsx`, `types/user.ts`, `types/document.ts`
- Presence is tracked in Firebase Realtime Database
- UI must show active collaborators (avatars/names/colors)

### Steps
- [x] Subscribe to presence updates for the active document
- [x] Add UI to display active users in the editor (e.g., avatar group)
- [x] Show user color/name in cursor or sidebar
- [x] Ensure presence is updated on join/leave
- [x] Enhanced version tracking with user information

---

## Phase 3: Team Review & Commenting

### Background/Architecture
- Uses: `types/comment.ts`, `components/document-editor.tsx`, `components/document-container.tsx`, Firestore for comment storage
- Comments are anchored to text ranges and can be resolved
- UI must allow adding, viewing, and resolving comments

### Steps
- [ ] Add Firestore collection for comments per document
- [ ] Implement UI for adding comments to selected text
- [ ] Display comments inline or in a sidebar
- [ ] Allow resolving/unresolving comments
- [ ] Sync comments in real time

---

## Phase 4: Document Sharing & Access Control

### Background/Architecture
- Uses: `services/document-service.ts`, `services/user-service.ts`, `types/user.ts`, `components/document-container.tsx`
- Documents can be shared with users/org members
- Access control (edit, comment, view) enforced in backend and UI

### Steps
- [ ] Add UI for inviting users by email/org
- [ ] Store access control list (ACL) in document metadata
- [ ] Enforce permissions in backend (Firestore security rules)
- [ ] Show current collaborators and their permissions
- [ ] Allow owner to change permissions or remove users

---

## Phase 5: Review & Approval Workflow

### Background/Architecture
- Uses: `types/document.ts`, `components/document-status-bar.tsx`, `components/document-container.tsx`
- Documents have a status: 'draft', 'review', 'final', 'archived'
- UI must allow status changes and notify collaborators

### Steps
- [ ] Add UI controls to change document status
- [ ] Display current status in the editor/status bar
- [ ] Notify collaborators of status changes (toast, email, etc.)
- [ ] Restrict editing based on status (e.g., 'final' is read-only)

---

## Checklist (per phase)

### Phase 1: Funnel Document Creation & Goals
- [ ] Document creation flow uses Writing Goals modal
- [ ] Goals and title saved to document

### Phase 1.5: AI-Powered Funnel Copy Suggestions
- [ ] Backend Cloud Function for funnel suggestions
- [ ] Suggestion types: headline, subheadline, cta, outline
- [ ] Suggestions stored in Firestore
- [ ] Sidebar UI for funnel suggestions
- [ ] Apply/dismiss suggestion actions
- [ ] Suggestion generation triggers on creation/goals change

### Phase 2: Real-Time Collaboration & Presence
- [x] Presence UI shows active collaborators
- [x] User colors and avatar generation
- [x] Real-time presence subscription
- [x] Join/leave session management
- [x] Enhanced version history with user tracking

### Phase 3: Team Review & Commenting
- [ ] Commenting UI for feedback and discussion

### Phase 4: Document Sharing & Access Control
- [ ] Sharing/invitation UI
- [ ] Access control logic

### Phase 5: Review & Approval Workflow
- [ ] Status controls and workflow UI
- [ ] Reviewer notifications 